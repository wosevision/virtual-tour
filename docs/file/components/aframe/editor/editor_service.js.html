<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">components/aframe/editor/editor_service.js | UOIT Virtual Tour API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/wosevision/virtualtour.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AppConfig">AppConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AppRun">AppRun</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-componentModule">componentModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">aframe/editor</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/editor/editor_controller.js~EditorCtrl.html">EditorCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/editor/editor_service.js~$aframeEditor.html">$aframeEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sceneEditor">sceneEditor</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">aframe/scene</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/scene/scene_controller.js~SceneCtrl.html">SceneCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/scene/scene_service.js~$aframeScene.html">$aframeScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aframeScene">aframeScene</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">components/aframe/editor/editor_service.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { pick } from &apos;lodash&apos;;
/**
 * Service for handling all CRUD operations pertaining to scenes.
 *
 * Contains methods for drafting and publishing; interfaces directly
 * with the `$aframeScene` service for a reference to the current
 * scene object. Uses:
 * 
 * - ng-material&apos;s `$mdToast` service to display UI messages to user
 * - the `$tourApi`&apos;s scene resource and the `DraftResource` for CRUD ops
 * - the &apos;EDITOR_MESSAGES&apos; constant to provide prebuilt dialogs and toasts
 * 
 * @param  {object} $mdToast        ng-material&apos;s toast service
 * @param  {object} $tourApi        Tour $resource factory service
 * @param  {object} DraftResource   Draft $resource factory
 * @param  {object} EDITOR_MESSAGES Constant to define toast configs
 */
class $aframeEditor {
	constructor($mdToast, $aframeScene, $tourApi, DraftResource, EDITOR_MESSAGES) {
		&apos;ngInject&apos;;
		this.$mdToast = $mdToast;
		this.$aframeScene = $aframeScene;
		this.DraftResource = DraftResource;
		this.SceneResource = $tourApi.scene;
		/**
		 * Property to hold an array of fully initialized toast config objects; loops
		 * through `EDITOR_MESSAGES` and sets properties using the methods provided
		 * by `$mdToast.simple()`&apos;s return.
		 *
		 * @memberof $aframeEditor
		 * @type {Object}
		 */
		this.toasts = {};
		Object.keys( EDITOR_MESSAGES ).forEach(type =&gt; {
			const toast = $mdToast.simple();
			const toastConfig = EDITOR_MESSAGES[type];
			Object.keys(toastConfig).forEach(prop =&gt; {
				toast[prop]( toastConfig[prop] );
			});
			this.toasts[type] = toast;
		});
	}

	/**
	 * Sends an HTTP `POST` or `PATCH` request via the `$tourApi`&apos;s
	 * scene resource to publish (save) the current scene.
	 *
	 * If the scene is new, the first parameter of this method can be
	 * passed the new scene data, which makes it implicity truthy and
	 * tells the method to send the request as a new scene creation. If
	 * left to default, it will stay false and the method will assume
	 * the scene already exists and is being updated.
	 * 
	 * In the case of an update, Lodash&apos;s `pick()` method is used to grab
	 * applicable properties from the current `$aframeScene.scene` _without_
	 * creating ones that don&apos;t exist. A new `updatedAt` property is assigned
	 * a date for every action; if the data was new, the same date is given
	 * to a `createdAt` property.
	 * 
	 * @param  {Boolean}  _newData	Whether incoming data should be treated as new
	 * @param  {Boolean}  notify 		Whether to notify the user (toast)
	 * @return {Promise} 						Resolves to latest scene data
	 */
	publish(_newData = false, notify = true) {
		let action = &apos;update&apos;;
		const newData = _newData || pick(this.$aframeScene.scene, [
			&apos;_id&apos;,
			&apos;code&apos;,
			&apos;name&apos;,
			&apos;assets&apos;,
			&apos;entities&apos;,
			&apos;hotSpots&apos;,
			&apos;sceneLinks&apos;,
			&apos;panorama&apos;,
			&apos;parent&apos;,
			&apos;script&apos;
		]);
		newData.updatedAt = new Date();
		if (_newData) {
			newData.createdAt = newData.updatedAt;
			action = &apos;save&apos;;
		}

  	return this.SceneResource[action](_newData ? null : { 
  		id: newData._id
  	}, newData)
  	.$promise.then(scene =&gt; {
			this.lastPublished = this.$aframeScene.scene || scene;
  		notify&amp;&amp;this.$mdToast.show(this.toasts.publish);
  		return scene;
  	});
	}

	/**
	 * Sends an HTTP `POST` request to save a draft of the current scene.
	 * Offers to publish the scene when the draft is done saving; calls
	 * `publish()` if the user confirms.
	 * 
	 * @param  {Boolean} notify 	Whether to notify the user (toast)
	 * @return {Promise} 					Resolves to saved draft
	 */
	saveDraft(notify = true) {
  	return this.DraftResource.save({
  		content: this.$aframeScene.scene,
  		kind: &apos;Scene&apos;,
  		original: this.$aframeScene.scene._id
  	}).$promise.then(draft =&gt; {
	  	this.lastDraft = draft.content;
	    notify&amp;&amp;this.$mdToast.show(this.toasts.saveDraft).then(response =&gt; {
	      if ( response == &apos;ok&apos; ) {
	      	this.publish();
	      }
	    });
	    return draft;
  	});
  }

	/**
	 * If there is scene data available, queries the database by the current
	 * scene ID via the `DraftResource` factory to check for active drafts
	 * held by the current logged in user.
	 * 
	 * @param  {Boolean}  notify 		Whether to notify the user (toast)
	 * @return {Promise}            Promise that will resolve to draft list
	 */
	checkForDraft(notify = true) {
		return (this.$aframeScene.scene)&amp;&amp;this.DraftResource.query({
			sort: &apos;-updatedAt&apos;,
			filter: {
				original: this.$aframeScene.scene._id
			}
		}).$promise;
	}

	/**
	 * Informs a user that draft[s] have been found for the scene
	 * they are viewing and offers to load the most recent draft; calls
	 * `loadDraft()` if the user confirms and supplies it the `_id` of
	 * the first draft in the found draft list.
	 * 
	 * @param  {Array}   drafts A list of available drafts
	 * @return {Promise}      	Resolves to toast result &#xBB; loadDraft promise
	 */
	draftFound(drafts) {
		return this.$mdToast.show(this.toasts.draftFound)
			.then( response =&gt; (response === &apos;ok&apos;) &amp;&amp; this.loadDraft(drafts[0]._id) );
	}

	/**
	 * Gets a single stored draft by its database `_id` and passes
	 * the result to a callback; notifies user that draft was loaded and
	 * offers to publish.
	 * 
	 * @param  {string}   id        The id of the draft to fetch
	 * @param  {Boolean}  notify 		Whether to notify the user (toast)
	 * @return {Promise} 					  Resolves to content of the loaded draft
	 */
	loadDraft(id, notify = true) {
  	return this.DraftResource.get({ id }).$promise.then(draft =&gt; {
	  	this.lastDraft = draft.content;
	    notify &amp;&amp; this.$mdToast.show(this.toasts.draftLoaded)
		    .then( response =&gt; ( response === &apos;ok&apos; ) &amp;&amp; this.publish() );
	    return draft.content;
  	});
	}

	/**
	 * Immediately load last saved draft of current scene.
	 * @param  {Boolean}  notify 		Whether to notify the user (toast)
	 * @return {Promise} 					  Resolves to state of confirm toast
	 */
	revertToDraft(notify = true) {
		return this.checkForDraft(false)
			.then( drafts =&gt; this.loadDraft(drafts[0]._id, false) )
	  	.then( draftContent =&gt; notify &amp;&amp; this.$mdToast.show(this.toasts.revertToDraft) );	
	}

	/**
	 * Sends an HTTP `DELETE` request to remove a stored draft by
	 * its database `_id`; notifies user if successful.
	 * 
	 * @param  {string}   id        The id of the draft to delete
	 * @param  {Boolean}  notify 		Whether to notify the user (toast)
	 * @return {Promise} 					  Resolves to state of confirm toast
	 */
	discardDraft(id, notify = true) {
  	return this.DraftResource.remove({ id }).$promise
	  	.then( discardedDraft =&gt; notify &amp;&amp; this.$mdToast.show(this.toasts.discardDraft) );
	}
}

export default $aframeEditor;</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
