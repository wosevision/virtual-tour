<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">components/aframe/sky/sky_service.js | UOIT Virtual Tour API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/wosevision/virtualtour.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AppConfig">AppConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AppRun">AppRun</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-componentModule">componentModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">aframe/editor</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/editor/editor_controller.js~EditorCtrl.html">EditorCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/editor/editor_service.js~$aframeEditor.html">$aframeEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sceneEditor">sceneEditor</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">aframe/scene</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/scene/scene_controller.js~SceneCtrl.html">SceneCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/scene/scene_service.js~$aframeScene.html">$aframeScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aframeScene">aframeScene</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">components/aframe/sky/sky_service.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { utils } from &apos;aframe&apos;;

const COMPRESS_MAX = 100, COMPRESS_FACTOR = 12;

/**
 * The $aframeSky class is a service responsible for
 * the business logic of the aframeSky component.
 *
 * The SceneCtrl controller uses the `$aframeSky.sky`
 * getter/setter to detect changes to the active scene&apos;s
 * sky; the SkyCtrl controller uses the `getSkyDomNode()`
 * method to produce a fully loaded `&lt;img&gt;` for appending
 * the SceneCtrl.$assetsEl (`&lt;a-assets&gt;`).
 * 
 * @memberOf app.components.aframe.sky
 */
class $aframeSky {
	constructor($q, $tourApi, CBuffer, UserSession, GLOBAL_SETTINGS) {
		&apos;ngInject&apos;;
		this.$q = $q;
		this.Preload = $tourApi.preload;
		this.CircularBuffer = CBuffer;
		this.UserSession = UserSession;

		this.imageApiUrl = GLOBAL_SETTINGS.imageApiUrl;
	}
	/**
	 * Getter/setter for formatting sky URL from sceneData.
	 * 
	 * @type {string}
	 * @example
	 * &apos;http://res.cloudinary.com/uoit-virtual-tour/image/upload/v1480529929/scenes/panorama/k23dnerigdctblxgq5vm.jpg&apos;
	 */
	get sky() {
		return this.panorama ? [ this.panorama.version, this.panorama.public_id].join(&apos;/&apos;) : null;
	}
	set sky(panorama) {
		console.log(&apos;sky service set to:&apos;, panorama)
		this.panorama = panorama;
	}

	/**
	 * Utility function for reading and parsing user settings
	 * based on aframe&apos;s isMobile() method and the UserSession
	 * service&apos;s usage settings; parses into an object that
	 * eventually becomes a Cloudinary URL component string.
	 * 
	 * If the device is mobile, limit image resolution to 2048x1024
	 * due to rendering limit.
	 * 
	 * @return {string} Formatted Cloudinary setting string (`c_scale,f_auto,etc`)
	 */
	getSettings() {
		const mobile = (utils.isMobile || utils.device.isMobile)(),
					lowRes = !this.UserSession.usage.resolution.val;
		const settings = {
			w: mobile||lowRes ? 2048 : 4096,
			h: mobile||lowRes ? 1024 : 2048,
			c: &apos;scale&apos;,
			f: &apos;auto&apos;,
			q: COMPRESS_MAX - (COMPRESS_FACTOR * this.UserSession.usage.compression.val)
		}
		const output = [];
		Object.keys(settings).forEach(key =&gt; {
			output.push(`${key}_${settings[key]}`)
		})
		return output.join(&apos;,&apos;);
	}

	/**
	 * Fetches an efficiently-generated list of `skyUrl`s
	 * from the server, which uses a scene `_id` to read
	 * potential candidates for preloading from the scene&apos;s
	 * scenelinks.
	 *
	 * If the `UserSession` service&apos;s preloading settings are
	 * set to 1 or 2, it returns the full list for further
	 * manipulation; otherwise, it returns an empty array
	 * (0/no preload).
	 * 
	 * @param  {string} id The _id of a scene to preload links for
	 * @return {Promise}   A promise that will fulfill the preload list
	 */
	getPreloadList(id) {
		return this.$q((resolve, reject) =&gt; {
			switch(this.UserSession.usage.preloading.val) {
				case 0:
					resolve([]);
					break;
				case 1:
				case 2:
					this.Preload.get({ id }).$promise.then(data =&gt; resolve(data));
					break;
				default: 
					reject(&apos;Can\&apos;t determine preload settings&apos;)
			}
		});
	}

	/**
	 * Converts a skyUrl and an assetId into a fully
	 * compiled DOM element; returns a promise representing
	 * a sky asset that will eventually be fully loaded.
	 *
	 * Uses `getSettings()` to parse userSession settings
	 * into a Cloudinary setting string.
	 * 
	 * @param  {string} url Partial URL, e.g. `this.sky` getter/setter
	 * @param  {string} id  An asset ID, e.g. the panorama&apos;s `public_id`
	 * @return {Promise}    A promise that will resolve to the loaded `&lt;img&gt;`
	 */
	getSkyDomNode(url, id) {
	  return this.$q((resolve, reject) =&gt; {
			const img = angular.element(`&lt;img src=&quot;${ this.imageApiUrl }/${ this.getSettings() }/v${ url }&quot; id=&quot;${ id }&quot; crossOrigin=&quot;anonymous&quot; /&gt;`);
	    img.on(&apos;load&apos;, () =&gt; resolve(img));
	    img.on(&apos;error&apos;, () =&gt; reject(&apos;Image load error&apos;));
	  });
	}
}

export default {
  name: &apos;$aframeSky&apos;,
  fn: $aframeSky
};</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
