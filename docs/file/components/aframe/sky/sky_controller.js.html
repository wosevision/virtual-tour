<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">components/aframe/sky/sky_controller.js | UOIT Virtual Tour API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/wosevision/virtualtour.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AppConfig">AppConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AppRun">AppRun</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-componentModule">componentModule</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">aframe/editor</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/editor/editor_controller.js~EditorCtrl.html">EditorCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/editor/editor_service.js~$aframeEditor.html">$aframeEditor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sceneEditor">sceneEditor</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">aframe/scene</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/scene/scene_controller.js~SceneCtrl.html">SceneCtrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/components/aframe/scene/scene_service.js~$aframeScene.html">$aframeScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aframeScene">aframeScene</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">components/aframe/sky/sky_controller.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * The `SkyCtrl` class is largely responsible for
 * orchestrating the translation of URLs into IDs
 * and then into DOM elements for attaching to the scene.
 *
 * It attaches a single `&lt;a-sky/&gt;` the first time a sky is
 * loaded, and attaches `&lt;img/&gt;`s to the scenes assets
 * preload bucket based on the `$aframeSky` service&apos;s instructions.
 * 
 * @memberOf app.components.aframe.sky
 */
class SkyCtrl {
	/**
	 * Initializes the controller&apos;s dependencies:
	 * - Binds a special one-off $compile function for when
	 * 	 the scene&apos;s `&lt;a-sky /&gt;` needs to be compiled
	 * - Attaches the $aframeSky service directly
	 * 
	 * @param  {object} $scope     The SkyCtrl&apos;s scope
	 * @param  {object} $compile   Angular&apos;s compile service
	 * @param  {object} $aframeSky The sky component&apos;s biz logic
	 */
	constructor($scope, $compile, $aframeSky) {
		&apos;ngInject&apos;;
		this.compileSkyEl = callback =&gt; $compile(&apos;&lt;a-sky ng-src=&quot;{{ \&apos;#\&apos; + $ctrl.loadedSky }}&quot; /&gt;&apos;)($scope, callback);
		this.$aframeSky = $aframeSky;
	}

  /**
	 * Store JQLite-wrapped `&lt;a-scene&gt;` and `&lt;a-assets&gt;`;
	 * init internal check for right click event.
   * 
   * @return {void}		No return
   */
  $onInit() {
		/**
		 * Cache vars to store JQLite &lt;img&gt; and &lt;a-sky&gt;
		 * Flag for init sky load and array of loaded skies
		 * 
		 * @type {null}
		 * @type {null}
		 * @type {boolean}
		 * @type {Array}
		 */
		this.$sceneEl = this.SceneCtrl.$sceneEl;
		this.$assetsEl = this.SceneCtrl.$assetsEl;
		this._skyElLoaded = false;
		this._skyLoadedList = this.$aframeSky.CircularBuffer(10);
  }

  /**
   * Lifecycle hook that is invoked every time `SkyCtrl.sky`
   * changes value. The first change is discarded since it will
   * always return `null` or `undefined`.
   * 
   * @param  {object} newData Incoming change object
   */
  $onChanges(newData) {
  	if (newData.sky.isFirstChange()) return;
  	let skyUrl = newData.sky.currentValue;
  	if (skyUrl) this.setSky(skyUrl, this.assetIdFromSkyUrl(skyUrl));
  }

  /**
   * Utility function for stripping the `public_id`
   * property out of a URL segment in the form of
   * `[version]/[path/to/image]/[public_id]`.
   * 
   * @param  {string} skyUrl Panorama URL segment
   * @return {string}        Panorama&apos;s public_id
   */
	assetIdFromSkyUrl(skyUrl) {
		return skyUrl.split(&apos;scenes/panorama/&apos;)[1].split(&apos;.&apos;)[0]
	}

	/**
	 * Uses the $aframeSky service to fetch a server-generated
	 * list of `skyUrl`s for asset preloading. It grabs the `_id`
	 * of the current active scene from `SceneCtrl` and sends it
	 * through `$aframeSky.getPreloadList()` to generate the list
	 * based on scenelinks in the current active scene.
	 *
	 * `assetIdFromSkyUrl()` turns each `skyUrl` into an `assetId`,
	 * which is checked against the list of preloaded assets.
	 * If the asset hasn&apos;t been loaded and stored already, &apos;loadSkyAsset()&apos;
	 * queues it up for loading into the scene&apos;s `&lt;a-assets&gt;&lt;/a-assets&gt;`.
	 * 
	 * @return {Promise} Promise that holds an array of skyUrls from server
	 */
	preload() {
		this.$aframeSky.getPreloadList(this.SceneCtrl._currentSceneId)
			.then(toPreload =&gt; {
				toPreload.forEach(skyUrl =&gt; {
					const newAssetId = this.assetIdFromSkyUrl(skyUrl)
					if (!this._skyLoadedList.toArray().includes(newAssetId)) {
						this.loadSkyAsset(skyUrl, newAssetId);
					}
				});
			})
			.catch(err =&gt; {
				console.warn(err);
			});
	}

	/**
	 * Sets the current active sky to an `assetId`. This updates the
	 * binding in the scene&apos;s `&lt;a-sky ng-src=&quot;{{ $ctrl.loadedSky }}&quot; /&gt;`
	 * to the provided `assetId`, which should match the `id=&quot;&quot;` of a
	 * asset that has already been fully loaded since this represents
	 * the largest and final change a user perceives when switching scenes.
	 *
	 * If this function is being called, it is safe to assume all
	 * requisite loading steps for scene transition have completed, so
	 * it is safe to `preload()` the next wave of assets.
	 * 
	 * @param {string} assetId public_id of panorama that is done loading
	 */
	setSkyId(assetId) {
		this.loadedSky = assetId;
		this.preload();
	}

	/**
	 * Acts as a buffer function to `setSkyId()` by checking if the
	 * incoming assetId is already in the list of loaded skies &#x2013;
	 * if the list includes the ID, `setSkyId()` is called on the ID
	 * directly. If the ID is missing from the list, `loadSkyAsset()`
	 * is initiated.
	 * 
	 * `setSkyId()` is called after the promise is resolved inside its
	 * `then()` method, where a check is also performed whether the
	 * scene needs an `&lt;a-sky /&gt;` element.
	 * 
	 * @param {string} skyUrl  Panorama URL segment
	 * @param {string} assetId Panorama&apos;s public_id
	 */
	setSky(skyUrl, assetId) {
    return this._skyLoadedList.toArray().includes(assetId) ?
      this.setSkyId(assetId) :
      this.loadSkyAsset(skyUrl, assetId)
      	.then(assetId =&gt; {
	        if(!this._skyElLoaded) {
	          this.$skyEl = this.loadSkyEl();
	        }
	        this.setSkyId(assetId)
	      });
	}

	/**
	 * Compiles a new image asset with requested URL and ID;
	 * adds element to assets and ID to list to prevent reload.
	 * 
	 * @param {string} skyUrl  Panorama URL segment
	 * @param {string} assetId Panorama&apos;s public_id
	 * @return {string}        The original assetId
	 */
	loadSkyAsset(skyUrl, assetId) {
		return this.$aframeSky.getSkyDomNode(skyUrl, assetId)
			.then(imgNode =&gt; {
				this.$assetsEl.append(imgNode);
				this._skyLoadedList.push(assetId);
				console.log(&apos;sky asset preloaded: &apos;, skyUrl)
				return assetId;
			})
	}

	/**
	 * Runs the `compileSkyEl()` method from the constructor
	 * to build the sky element; attaches it to the scene
	 * and marks the element as loaded.
	 * 
	 * @param  {string} sky ID for asset reference
	 * @return {Element}    JQLite-wrapped &lt;a-sky&gt; element
	 */
	loadSkyEl() {
		return this.compileSkyEl(clone =&gt; {
			this.$sceneEl.append(clone);
			this._skyElLoaded = true;
			return clone;
		});
	}
}

export default {
  name: &apos;SkyCtrl&apos;,
  fn: SkyCtrl
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
